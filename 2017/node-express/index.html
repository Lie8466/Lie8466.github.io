<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> node+express实现图片上传功能 · Yawei Li</title><meta name="description" content="node+express实现图片上传功能 - Yawei Li"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon3.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Yawei Li"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon3.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://juejin.im/user/59f05612f265da432c23100c" target="_blank" class="nav-list-link">JUEJIN</a></li><li class="nav-list-item"><a href="https://github.com/Lie8466" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">node+express实现图片上传功能</h1><div class="post-info">Nov 27, 2017</div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本篇文章适用于node刚刚入门的读者。</p>
<p>本篇文章使用node+express实现了一个简单的图片上传功能：用户点击图片上传，会跳转到上传成功页面并展示上传的图片。</p>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一直想找资料入门node，试着一步步实现一个功能，都没有合适的资料。直到看到<a href="https://www.nodebeginner.org/index-zh-cn.html#" target="_blank" rel="noopener">https://www.nodebeginner.org/index-zh-cn.html#</a> ，这本书教你如何<strong>一步一步</strong>结合基本的API搭建一个简单的应用，实现了简单的图片上传功能。我看完之后终于感觉自己<strong>基本入门</strong>node了。文章中有附源码地址，<a href="https://github.com/manuelkiessling/nodebeginner.org/tree/master/code/application" target="_blank" rel="noopener">https://github.com/manuelkiessling/nodebeginner.org/tree/master/code/application</a> ，如果你感觉还没有入门node，可以试试这本书。</p>
<p>当然我的建议是跟着教程一步步修改代码，而不是直接将源码clone下来。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>文章到后面给出页面展示的html是以<code>response.write(body);</code>的方式写的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function start(response) &#123;</span><br><span class="line">console.log(&quot;Request handler &apos;start&apos; was called.&quot;);</span><br><span class="line"></span><br><span class="line">var body = &apos;&lt;html&gt;&apos;+</span><br><span class="line">&apos;&lt;head&gt;&apos;+</span><br><span class="line">&apos;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; &apos;+</span><br><span class="line">&apos;charset=UTF-8&quot; /&gt;&apos;+</span><br><span class="line">&apos;&lt;/head&gt;&apos;+</span><br><span class="line">&apos;&lt;body&gt;&apos;+</span><br><span class="line">&apos;&lt;form action=&quot;/upload&quot; enctype=&quot;multipart/form-data&quot; &apos;+</span><br><span class="line">&apos;method=&quot;post&quot;&gt;&apos;+</span><br><span class="line">&apos;&lt;input type=&quot;file&quot; name=&quot;upload&quot; multiple=&quot;multiple&quot;&gt;&apos;+</span><br><span class="line">&apos;&lt;input type=&quot;submit&quot; value=&quot;Upload file&quot; /&gt;&apos;+</span><br><span class="line">&apos;&lt;/form&gt;&apos;+</span><br><span class="line">&apos;&lt;/body&gt;&apos;+</span><br><span class="line">&apos;&lt;/html&gt;&apos;;</span><br><span class="line"></span><br><span class="line">response.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;text/html&quot;&#125;);</span><br><span class="line">response.write(body);</span><br><span class="line">response.end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际应用中肯定不能以这样的方式写html文件，所以接下来就教你用node+express实现同样的功能，使我们的代码看起来更优雅</p>
<h2 id="node-express实现图片上传功能"><a href="#node-express实现图片上传功能" class="headerlink" title="node+express实现图片上传功能"></a>node+express实现图片上传功能</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>mac+node(v9.2.0)+express</p>
<h3 id="安装express"><a href="#安装express" class="headerlink" title="安装express"></a>安装express</h3><blockquote>
<p>express官网:<a href="http://www.expressjs.com.cn/" target="_blank" rel="noopener">http://www.expressjs.com.cn/</a></p>
</blockquote>
<p>新建文件夹<code>node-app</code>，在文件夹下新建<code>package.json</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;node-app&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;0.0.1&quot;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;express&quot;: &quot;^4.16.2&quot;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行<code>npm install</code>。新建<code>app.js</code>，代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">    res.send(&apos;Hello World!&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var server = app.listen(3000, function () &#123;</span><br><span class="line">    var host = server.address().address;</span><br><span class="line">    var port = server.address().port;</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Example app listening at http://%s:%s&apos;, host, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行<code>node app.js</code>，打开<a href="localhost:3000" target="_blank" rel="noopener">localhost:3000</a>，应用已经跑起来了</p>
<h3 id="利用-Express-托管静态文件"><a href="#利用-Express-托管静态文件" class="headerlink" title="利用 Express 托管静态文件"></a>利用 Express 托管静态文件</h3><p>下面利用 Express 托管静态文件，在<code>node-app</code>下新建文件夹<code>public</code>，新建两个html文件</p>
<ul>
<li>start.html</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;</span><br><span class="line">    &lt;title&gt;请上传您的文件&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;./upload.html&quot; enctype=&quot;multipart/form-data&quot; method=&quot;get&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;upload&quot; multiple=&quot;multiple&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;Upload file&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>upload.html</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;</span><br><span class="line">    &lt;title&gt;上传成功&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;上传成功&lt;/h1&gt;</span><br><span class="line">    &lt;img  src=&quot;/public/test.png&quot;/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>修改<code>app.js</code>，增加<code>app.use(&#39;/public&#39;, express.static(&#39;public&#39;));</code>。修改后<code>app.js</code>如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">    res.send(&apos;Hello World!&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&apos;/public&apos;, express.static(&apos;public&apos;));</span><br><span class="line"></span><br><span class="line">var server = app.listen(3000, function () &#123;</span><br><span class="line">    var host = server.address().address;</span><br><span class="line">    var port = server.address().port;</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Example app listening at http://%s:%s&apos;, host, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>现在，public 目录下面的文件就可以访问了。</p>
<blockquote>
<p>参考文档：<a href="http://www.expressjs.com.cn/starter/static-files.html" target="_blank" rel="noopener">http://www.expressjs.com.cn/starter/static-files.html</a></p>
</blockquote>
<p>重启node服务，打开<br><code>http://localhost:3000/public/start.html</code>，选择文件上传之后，页面就会自动跳转到上传成功页面</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/11/25/15ff0e22bfb38f51?w=756&amp;h=176&amp;f=png&amp;s=25194" alt=""></p>
<h3 id="处理上传的图片"><a href="#处理上传的图片" class="headerlink" title="处理上传的图片"></a>处理上传的图片</h3><p>使用模块<code>formidable</code>处理请求数据。在<code>package.json</code>中增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">  &quot;express&quot;: &quot;^4.16.2&quot;,</span><br><span class="line">  &quot;formidable&quot;: &quot;^1.1.1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行<code>npm install</code>。</p>
<p>文件上传自然要用到post请求,更改<code>start.html</code>，改为<code>method=&quot;post&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/upload&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;upload&quot; multiple=&quot;multiple&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;Upload file&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>处理post请求用到的Express的路由</p>
<blockquote>
<p>参考 <a href="http://www.expressjs.com.cn/starter/basic-routing.html" target="_blank" rel="noopener">http://www.expressjs.com.cn/starter/basic-routing.html</a></p>
</blockquote>
<p>修改后的<code>app.js</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line">var formidable = require(&quot;formidable&quot;);</span><br><span class="line">fs = require(&quot;fs&quot;);</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">    res.send(&apos;Hello World!&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&apos;/public&apos;, express.static(&apos;public&apos;));</span><br><span class="line"></span><br><span class="line">app.post(&apos;/upload&apos;, function (req, res) &#123;</span><br><span class="line">    var form = new formidable.IncomingForm();</span><br><span class="line">    console.log(&quot;about to parse&quot;);</span><br><span class="line">    form.parse(req, function(error, fields, files) &#123;</span><br><span class="line">        console.log(&quot;parsing done&quot;);</span><br><span class="line">        console.log(files.upload.path);</span><br><span class="line">        fs.writeFileSync(&quot;public/test.png&quot;, fs.readFileSync(files.upload.path));</span><br><span class="line">        res.redirect(&quot;/public/upload.html&quot;) ;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var server = app.listen(3000, function () &#123;</span><br><span class="line">    var host = server.address().address;</span><br><span class="line">    var port = server.address().port;</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Example app listening at http://%s:%s&apos;, host, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在<code>public</code>文件夹下新增<code>upload.html</code>,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;</span><br><span class="line">    &lt;title&gt;上传成功&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;上传成功&lt;/h1&gt;</span><br><span class="line">    &lt;img  src=&quot;/public/test.png&quot;/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>嗯，大功告成啦。重新启动服务，打开 <a href="http://localhost:3000/public/start.html" target="_blank" rel="noopener">http://localhost:3000/public/start.html</a> 选择一个图片上传，就能看到自己上传的图片了！</p>
<p>源码附上，<a href="https://github.com/Lie8466/node-app/tree/node-express" target="_blank" rel="noopener">https://github.com/Lie8466/node-app/tree/node-express</a></p>
<p>感谢您的阅读！这是我的学习过程，希望对你有所帮助~</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://www.nodebeginner.org/index-zh-cn.html#" target="_blank" rel="noopener">https://www.nodebeginner.org/index-zh-cn.html#</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/what-pwa/" class="prev">PREV</a><a href="/2017/arguments-slice/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">Yawei Li</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>